---
apiVersion: "source.toolkit.fluxcd.io/v1"
kind: "OCIRepository"
metadata:
  name: "cilium"
  namespace: "flux-system"
spec:
  interval: "24h"
  layerSelector:
    mediaType: "application/vnd.cncf.helm.chart.content.v1.tar+gzip"
    operation: "copy"
  ref:
    semver: "^1.19.0"
  url: "oci://quay.io/cilium/charts/cilium"
---
apiVersion: "helm.toolkit.fluxcd.io/v2"
kind: "HelmRelease"
metadata:
  name: "cilium"
  namespace: "flux-system"
spec:
  chartRef:
    kind: "OCIRepository"
    name: "cilium"
    namespace: "flux-system"
  interval: "10m"
  releaseName: "cilium"
  targetNamespace: "kube-system"
  values:
    cgroup:
      autoMount:
        enabled: false
      hostRoot: "/sys/fs/cgroup"
    externalIPs:
      enabled: true
    ingressController:
      default: true
      enabled: true
      loadbalancerMode: "shared"
    ipam:
      mode: "kubernetes"
    k8sServiceHost: "localhost"
    k8sServicePort: 7445
    kubeProxyReplacement: true
    l2announcements:
      enabled: true
    securityContext:
      capabilities:
        ciliumAgent:
          - "CHOWN"
          - "KILL"
          - "NET_ADMIN"
          - "NET_RAW"
          - "IPC_LOCK"
          - "SYS_ADMIN"
          - "SYS_RESOURCE"
          - "DAC_OVERRIDE"
          - "FOWNER"
          - "SETGID"
          - "SETUID"
        cleanCiliumState:
          - "NET_ADMIN"
          - "SYS_ADMIN"
          - "SYS_RESOURCE"
